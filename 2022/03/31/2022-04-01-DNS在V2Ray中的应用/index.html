<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="Vic2ray" />
  <meta name="description" content="" />
  
  
  <title>
    
      DNS在V2Ray中的应用 
      
      
      |
    
     Vic2ray&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>

<meta name="generator" content="Hexo 6.1.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Vic2ray</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">分类</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">标签</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">DNS在V2Ray中的应用</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2022-03-31 16:00:00
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="计算机网络">
                    <b>#</b> 计算机网络
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/proxy/" title="proxy">
                    <b>#</b> proxy
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/DNS/" title="DNS">
                    <b>#</b> DNS
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>DNS及其应用：<a target="_blank" rel="noopener" href="https://steemit.com/cn/@v2ray/dns">https://steemit.com/cn/@v2ray/dns</a></p>
<p><a target="_blank" rel="noopener" href="https://tachyondevel.medium.com/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0">漫谈各种黑科技式 DNS 技术在代理环境中的应用</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/notion/notion20220412102529.png" alt="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/notion/notion20220412102529.png"></p>
<h1 id="使用情境"><a href="#使用情境" class="headerlink" title="使用情境"></a>使用情境</h1><p>即使你不使用代理功能，现在 V2Ray 也可以作为一个<strong>智能 DNS</strong>来用了。更多有趣的功能还等着你来发掘。</p>
<h2 id="广告屏蔽"><a href="#广告屏蔽" class="headerlink" title="广告屏蔽"></a>广告屏蔽</h2><p>V2Ray 的 DNS 服务器自带了 hosts 功能。当然我们的 hosts 比传统的操作系统自带的 hosts 文件强大很多，你只需要一行就可以屏蔽很多广告域名了。示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;geosite:category-ads&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这一项的意思是对于所有 ‘category-ads’ 中的域名，把 IP 解析到 ‘127.0.0.1’，即一个肯定访问不了的 IP。’category-ads’ 是 ‘geosite’中的一个特殊项，它包含了一些常见的广告域名，具体的内容<a target="_blank" rel="noopener" href="https://github.com/v2ray/domain-list-community/blob/master/data/category-ads">点这里</a>。如果你觉得还不够的话，欢迎按照格式提交 PR。</p>
<h2 id="域名别名"><a href="#域名别名" class="headerlink" title="域名别名"></a>域名别名</h2><p>由于众所周知的原因，’<a target="_blank" rel="noopener" href="http://v2ray.com/">v2ray.com</a>‘ 的 IP 在某些地区被解析到了 Facebook 的数据中心。实际上，’<a target="_blank" rel="noopener" href="http://v2ray.com/">v2ray.com</a>‘ 用的是 CloudFlare 的服务。<strong>CloudFlare 是一个 CDN，它的单个 IP，通常可以承载多个域名的流量</strong>。于是，我们即使不查询 ‘<a target="_blank" rel="noopener" href="http://v2ray.com/">v2ray.com</a>‘，而使用另一个域名（比如 ‘<a target="_blank" rel="noopener" href="http://www.vicemc.net/">www.vicemc.net</a>‘），同样也可以得到一个可用的 IP。配置样例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domain:v2ray.com&quot;</span><span class="punctuation">:</span> <span class="string">&quot;www.vicemc.net&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中 ‘dns’ 和 ‘hosts’ 和上面一段的配置是一模一样的，实际的配置中，只需要写一遍就可以了。区别是这里把所有 ‘<a target="_blank" rel="noopener" href="http://v2ray.com/">v2ray.com</a>‘ 的域名（包括子域名）指向了 ‘<a target="_blank" rel="noopener" href="http://www.vicemc.net/">www.vicemc.net</a>‘。在实际使用中，V2Ray 会通过 DNS 传出代理，拦截 ‘<a target="_blank" rel="noopener" href="http://v2ray.com/">v2ray.com</a>‘ 的查询，改写成 ‘<a target="_blank" rel="noopener" href="http://www.vicemc.net/">www.vicemc.net</a>‘ 再发送出去，完全避免了 DNS 污染。</p>
<h2 id="DNS查询分流"><a href="#DNS查询分流" class="headerlink" title="DNS查询分流"></a>DNS查询分流</h2><p>在使用代理的时候，DNS 查询经常得到不合理的 IP，比如淘宝被解析到了一个国外的 IP，导致访问缓慢。这是因为代理软件修改了来源 IP 地址，DNS 服务器不知道你的实际位置，而是返回了一个离代理服务器较近的 IP 地址。解决这一问题的方法有很多，比如 EDNS Client Subnet。</p>
<p>这里 V2Ray 提供了一个理解起来更方便的方法：DNS 分流。即对于国内的域名，向国内的 DNS 服务器发送查询；其它的域名，向国外的服务器查询。示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这段配置的意思是，所有常用的国内域名（’geosite:cn’）都使用 ‘114.114.114.114’ 作为 DNS 服务器；而其它的域名使用 ‘1.1.1.1’。**’geosite:cn’ 尽可能地包含了国内外 IP 地址不同的域名**，这些域名需要查询就近的 DNS 服务器。而对于那些只有单个 IP 的小站点，查哪里是一样的</p>
<h1 id="DNS使用配置"><a href="#DNS使用配置" class="headerlink" title="DNS使用配置"></a>DNS使用配置</h1><h2 id="未代理"><a href="#未代理" class="headerlink" title="未代理"></a>未代理</h2><ol>
<li>终端主机发出DNS域名解析请求，IP数据报形式为UDP段文</li>
<li>所请求的本地DNS服务器为终端主机网络设置的DNS服务器，如<code>223.5.5.5</code>，备用223.6.6.6；在手机上使用数据流量则请求ISP的DNS服务器。该过程一般为递归查询</li>
<li>本地DNS服务器向其他域名服务器发起迭代查询</li>
<li>查询结果(IP地址)由本地DNS服务器返回给终端主机</li>
<li>终端主机以该IP地址作为<code>dest ip address</code> 向目标域名的主机发送HTTP报文，或HTTPS握手连接</li>
</ol>
<h2 id="SOCK5代理"><a href="#SOCK5代理" class="headerlink" title="SOCK5代理"></a>SOCK5代理</h2><p>开启V2Ray本地代理，入口设置为<code>socks</code> 即SOCKS5代理，出口设置为<code>freedom</code> 直连：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span> <span class="comment">// 监听端口</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span> <span class="comment">// 入口协议为 SOCKS 5</span></span><br><span class="line">				<span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;noauth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span> <span class="comment">// 出口协议</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此时，由于V2Ray接管了本地终端的所有流量，并以直连的方式向外发出请求。虽然V2Ray也代理了UDP请求，但这无疑是画蛇添足多此一举——只不过换了一个工具来发起UDP请求。</p>
<p>加了这么一层代理，看起来什么都没发生，只是换了角色，其实不然，角色这么一换，可做的事情就相当多了。拿 DNS 来说，原来是浏览器发起的 DNS 请求，我们没办法控制浏览器怎么去发这个 DNS 请求（你不可能去改浏览器的源代码自己编译一个来用吧？），但换成由 V2Ray 来发这个 DNS 请求后，我们就可以做很多事情。</p>
<p>修改配置，将出口流量的域名解析策略<code>domainStrategy</code>设置为<code>UseIP</code> ：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">	    <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span> <span class="comment">// 出口协议</span></span><br><span class="line">	    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	        <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UseIP&quot;</span></span><br><span class="line">	    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>V2Ray文档中对<code>freedom</code>直连出口设置的改项解释为：当目标地址为域名时（通常是DNS查询数据报），直接向此域名发出连接（”<code>AsIs</code>“），或使用V2Ray内置的DNS解析为IP后再进行连接（”<code>UseIP</code>“、”<code>UseIPv4</code>“、”<code>UseIPv6</code>”）</p>
<p>也就是说，V2Ray在代理终端UDP查询的基础上，能够更改本地查询的DNS服务器。添加DNS配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过Wireshark抓包能够看到DNS查询的服务器为233.5.5.5，而且同时也会向”8.8.8.8”, “1.1.1.1”(Windows电脑设置的DNS)发起DNS查询：</p>
<p><img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/notion/notion20220412102559.png" alt="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/notion/notion20220412102559.png"></p>
<p>因为我们配置了三个DNS服务器，且没有设置任何<strong>路由规则</strong>（后续有重要作用），V2Ray会按照顺序发起DNS查询请求</p>
<h2 id="路由选择"><a href="#路由选择" class="headerlink" title="路由选择"></a>路由选择</h2><p>DNS查询与路由选择密切相关。<strong>路由选最佳出口</strong>需要DNS查询来完成。当设置了V2Ray的路由规则后，符合匹配规则的inbounds流量将从对应的outbounds发出。我们首先需要设置两个不同的出口：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span> <span class="comment">// 这个出口直连</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span> <span class="comment">// 出口协议</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UseIP&quot;</span> <span class="comment">// 使用内置DNS解析</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;myProxy&quot;</span><span class="punctuation">,</span> <span class="comment">// 这个出口将到我的远端代理服务器</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.12.246.131&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">16823</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0c408899-c843-4f63-af6a-539d17070531&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;alertId&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>一个出口为本地直连，一个出口为远端V2Ray代理服务器。接下来我们设置路由规则：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPIfNonMatch&quot;</span><span class="punctuation">,</span> <span class="comment">// 域名策略</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span> <span class="comment">// 匹配类型</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// 匹配IP列表</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;myProxy&quot;</span> <span class="comment">// 使用代理出口</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// 匹配域名列表</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span> <span class="comment">// 使用直连出口</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>第一条路由规则设置为：当匹配到目标IP为“8.8.8.8”时，使用远端代理服务器进行请求；</p>
<p>第二天路由规则为：当域名匹配国内常见域名时，使用直连出口；同时，在直连出口中我们设置了使用内置DNS进行解析。</p>
<p>但是路由的域名策略是什么呢？</p>
<blockquote>
<p>V2Ray 内建了一个简单的路由功能，可以将入站数据按需求由不同的出站连接发出，以达到按需代理的目的。这一功能的常见用法是分流国内外流量，V2Ray 可以通过内部机制判断不同地区的流量，然后将它们发送到不同的出站代理。****</p>
</blockquote>
<ul>
<li><p><code>“AsIs”</code>：只使用域名进行路由选择。默认值。</p>
</li>
<li><p>&#96;&#96;&#96;<br>“IPIfNonMatch”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  : 当域名没有匹配任何规则时，使用内置DNS将域名解析成 IP（A 记录或 AAAA 记录）</span><br><span class="line"></span><br><span class="line">  再次</span><br><span class="line"></span><br><span class="line">  进行匹配；</span><br><span class="line"></span><br><span class="line">  - 当一个域名有多个 A 记录时，会尝试匹配所有的 A 记录，直到其中一个与某个规则匹配为止；</span><br><span class="line">  - 解析后的 IP 仅在路由选择时起作用，转发的数据包中依然使用原始域名；</span><br><span class="line"></span><br><span class="line">- `&quot;IPOnDemand&quot;`: 当匹配时碰到任何基于 IP 的规则，将域名立即解析为 IP 进行匹配；</span><br><span class="line"></span><br><span class="line">我们回看以上两条路由规则：</span><br><span class="line"></span><br><span class="line">1. 当访问国内地址时，经过路由规则匹配到了直连出口</span><br><span class="line">2. 当访问google.com时，发现没有这个域名的路由匹配，也就找不到出口</span><br><span class="line">3. 但由于设置了`IPIfNonMatch` ，路由转而告诉V2Ray核心去解析出IP再来进行路由选择</span><br><span class="line">4. 于是V2Ray使用内置的DNS对google.com进行DNS解析，配置中第一个DNS为8.8.8.8</span><br><span class="line">5. 发出的DNS解析是UDP段，目的地址是8.8.8.8，于是匹配到了第一条路由规则</span><br><span class="line">6. 这个DNS查询将发往`myProxy` ，由远端V2ray服务代解析，再把解析结果传回来</span><br><span class="line"></span><br><span class="line">以上，远端服务器仅仅充当了代理DNS的功能。如果要代理后续的HTTP请求呢？在本地出口设置`streamSettings` 为TCP传输：</span><br><span class="line"></span><br><span class="line">```json</span><br><span class="line">&quot;outbounds&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;tag&quot;: &quot;myProxy&quot;, // 这个出口将到我的远端代理服务器</span><br><span class="line">        &quot;protocol&quot;: &quot;vmess&quot;,</span><br><span class="line">        &quot;settings&quot;: &#123;</span><br><span class="line">            &quot;vnext&quot;: [&#123;//...&#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;streamSettings&quot;: &#123; // 流传输设置</span><br><span class="line">            &quot;network&quot;: &quot;tcp&quot; // TCP流量</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这意味着本地V2Ray将与远端V2Ray建立起TCP流量隧道的代理连接。</p>
<p>小结：一般来说，流量从 inbound 进入到 V2Ray，再进入到路由匹配过程，找到匹配到的 outbound，然后流量就给到这个 outbound 处理。V2Ray 虽然有多种 inbound，多种 outbound，以及很灵活的路由匹配规则，有时候会让人眼花缭乱，但这条流量流经的路线是默认的，没有特殊配置，流量都会按这个顺序在 V2Ray 内部传递。</p>
<h2 id="内置DNS"><a href="#内置DNS" class="headerlink" title="内置DNS"></a>内置DNS</h2><p>前文讲到，V2Ray可以设置出口流量的域名策略为<code>UseIP</code> 以使用内置DNS进行查询；同时在路由选择时，也会借用内置DNS进行IP解析以更好地匹配出口。对其他模块来说，内置DNS只负责解析传入域名的IP并返回列表。</p>
<h3 id="hosts"><a href="#hosts" class="headerlink" title="hosts"></a>hosts</h3><p>和系统中的&#x2F;etc&#x2F;hosts功能一样，V2Ray内置DNS下的hosts处理可以自定义DNS映射：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;www.google.com&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>由此可以衍生出更强大的功能，例如：屏蔽广告域名、DNS污染解除等</p>
<h3 id="servers"><a href="#servers" class="headerlink" title="servers"></a>servers</h3><p>终端可以配置一系列的DNS server提供给V2Ray，内置 DNS 会从上至下按顺序，向 servers 里每个 DNS 服务器发 DNS 依次请求，直到有结果返回，然后再把结果返回给路由模块：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>从内置 DNS 向 servers 列表中的 DNS 服务器发出的 DNS 请求的流量，并不是从本机直接发到对应的服务器（localhost 除外），而是会通过 outbound 发出去，假如是 Freedom outbound，的确还是会从本机直接发到相应 DNS 服务器，但假如是一个 VMess outbound，DNS 请求的流量就会被代理到 VMess 代理服务器上，由代理服务器发到相应的 DNS 服务器。</p>
</blockquote>
<p>也即V2Ray产生的DNS查询流量，将从路由选择的出口流出。但是问题来了，我配置了多个DNS服务器，查询时该走哪条道呢？<a target="_blank" rel="noopener" href="http://假如访问的是bilibili.com/">假如访问的是bilibili.com</a>，应该查询223.5.5.5，而访问google.com时应该查询8.8.8.8。虽然路由选择可以保证国内站点走freedom，国外站点走porxy，但不管是哪个出口，都是进行DNS查询，只不过是交给我本地来查询还是交给远端来查询。</p>
<p>V2Ray 当然已经考虑到这情况，有了所谓的 <code>DNS 分流</code> 功能：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;114.114.114.114&quot;</span>,</span><br><span class="line">        <span class="string">&quot;port&quot;</span>: 53,</span><br><span class="line">        // List of domains that use this DNS first.</span><br><span class="line">        <span class="string">&quot;domains&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;localhost&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这样配置内置 DNS，虽然 8.8.8.8 在第一，但因为要查询的域名 <a target="_blank" rel="noopener" href="http://www.bilibili.com/">www.bilibili.com</a> 匹配了第二项中的域名规则，内置 DNS 就会优先向第二个 DNS 服务器发出 DNS 请求。</p>
<p>这里有一个很容易忽略掉的过程，就是选择 outbound，我们用 DNS 分流功能选择了 DNS 服务器，还得在路由中配置合适的规则，来选合适的 outbound 向这个 DNS 服务器发出 DNS 请求流量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;domainStrategy&quot;</span>: <span class="string">&quot;IPIfNonMatch&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;8.8.8.8&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;223.5.5.5&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下上面的，要正确配置 V2Ray 内置 DNS：</p>
<ol>
<li>正确配置 servers 列表及域名分流（用域名信息来选 DNS 服务器）</li>
<li>正确为发出的 DNS 请求配置路由规则（用 DNS 服务器的地址信息以及流量的协议信息：IP，端口，tcp&#x2F;udp）</li>
</ol>
<h2 id="DNS-Outbound"><a href="#DNS-Outbound" class="headerlink" title="*DNS Outbound*"></a><em><strong>*DNS Outbound*</strong></em></h2><blockquote>
<p>我们上面的例子中所说的都是路由模块去调用内置 DNS，但路由模块仅仅是用它的结果来做规则匹配，而且是当配置了 <code>IPIfNonMatch/IPOnDemand</code> ，而且没有匹配任何域名规则的情况下，才用得到它，当下各种域名列表盛行，它的应用范围实际上是很窄的。</p>
</blockquote>
<p>就是说，我们实际上没有必要去通过路由来调用内置DNS得到IP来匹配路由，用域名列表匹配更合适</p>
<p><code>DNS outbound</code>可以说是一个把内置 DNS 的功能真正地开放出来，让各种程序、各种模块可以更加方便地使用得上内置 DNS 的一个功能。最主要的目的还是，有些时候希望把V2Ray单纯当做DNS分流应用来使用。</p>
<p>DNS outbound配置只有三个设置：network，address，port</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-out&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span>   <span class="comment">// 出站协议为DNS</span></span><br><span class="line">        <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>DNS outbound 最重要的功能是它的默认行为：对进来的 DNS 流量进行<strong>拦截、解析</strong>，以及对 A, AAAA 类型的 DNS 查询做<strong>重新转发</strong>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 某个应用程序发了一个 DNS 查询</span><br><span class="line">2. 这个 DNS 查询的流量通过某种方式进入了 DNS outbound（这里暂时不讨论究竟是通过什么方式进入 DNS outbound 的）</span><br><span class="line">3. 如果这个流量是个明文 DNS 请求，DNS outbound 肯定看得到里面内容，可以拿出里面的域名</span><br><span class="line">4. DNS outbound 调用内置 DNS 模块，把拿到的域名传进去</span><br><span class="line">5. 内置 DNS 模块根据它的配置去查这个域名的 IP，具体怎么查的，DNS outbound 并不知道，它只管要结果</span><br><span class="line">6. 内置 DNS 返回一些 IP 给 DNS outbound 后，DNS outbound 用这些 IP 生成了一个 DNS 回复</span><br><span class="line">7. DNS outbound 把这个 DNS 回复若无其事地返回给应用程序</span><br><span class="line">8. 应用程序当然不知道这个 DNS 回复具体是怎么来的，它没办法，只能相信中间链路，相信这个回复就是它想要的回复</span><br></pre></td></tr></table></figure>

<p>DNS outbound 的这种行为，实质上相当于 DNS 劫持，但说它是 DNS 劫持也不太对，因为是我们配置的，自愿让它 “劫持” 的。</p>
<p>那么，V2Ray能够实现重发DNS数据，重点就在于<strong>如何拦截到</strong>其他应用的DNS流量？</p>
<p>比如运行一个 <code>nslookup</code> 命令，默认它也不会用系统设置的代理，它是直接向系统设置的 DNS 服务器发 DNS 请求，怎么把这个请求的流量引导到 V2Ray 的 DNS outbound 呢？</p>
<h3 id="PC端使用"><a href="#PC端使用" class="headerlink" title="PC端使用"></a>PC端使用</h3><p>新建以下配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span>  <span class="comment">// 监听本地53端口。需要设置本地DNS为127.0.0.1才会进来</span></span><br><span class="line">            <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-in&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dokodemo-door&quot;</span><span class="punctuation">,</span>  <span class="comment">// dokodemo-door是V2Ray的DNS服务器应用程序</span></span><br><span class="line">            <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp,udp&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  <span class="comment">// 自定义映射</span></span><br><span class="line">            <span class="attr">&quot;domain:www.bilibili.com&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.2.3.4&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span>   <span class="comment">// 出站协议为DNS，将调用内置DNS进行查询</span></span><br><span class="line">            <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;inboundTag&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dns-in&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>  <span class="comment">// 路由匹配dns-in的Inbounds流量</span></span><br><span class="line">                <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-out&quot;</span>  <span class="comment">// 从dns-out出</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>命令行执行 nslookup<a target="_blank" rel="noopener" href="http://www.bilibili.com/">www.bilibili.com</a></li>
<li>因为系统 DNS 设置为 127.0.0.1</li>
<li>DNS 请求发到 dokodemo-door inbound</li>
<li>因为 “dns-in” -&gt; “dns-out” 路由规则，流量传给 DNS outbound</li>
<li>DNS outbound 识别到是个 DNS 请求，拿到域名 <a target="_blank" rel="noopener" href="http://www.bilibili.com/">www.bilibili.com</a>，调用内置 DNS</li>
<li>这个域名匹配到内置 DNS 的一条 hosts 规则，返回结果 1.2.3.4</li>
<li>于是 nslookup 查询<a target="_blank" rel="noopener" href="http://www.bilibili.com/">www.bilibili.com</a>的结果是 1.2.3.4</li>
</ol>
<p>让 V2Ray 充当 DNS 服务器，设置系统 DNS 是其中一个把 DNS 流量引导到 DNS outbound 中的方式。但今天我们大部分的上网操作都是在浏览器上进行了，浏览器用了 SOCKS5 代理的话也不需要本地去解析 DNS，所以这个应用场景不常见。</p>
<p>小结：PC端能够设置socks代理精准将DNS流量导向到内置DNS进行解析。</p>
<h3 id="移动端"><a href="#移动端" class="headerlink" title="移动端"></a>移动端</h3><blockquote>
<p><em>DNS outbound 开放出来后，最重要的应用场景，是在移动端和路由器上。</em></p>
</blockquote>
<blockquote>
<p>在讨论移动端和路由器之前，先看看桌面系统上怎样可以做真正的全局代理。前面也说了，一般的浏览器代理，只代理浏览器的流量，要把 DNS 流量也代理了，就需要像上面那样更改系统 DNS 为 127.0.0.1，当我们需要真正的全局代理时（VPN 就是真正的全局代理），这种方便显然不合适，也不可能做得到真正全局代理。</p>
</blockquote>
<p>请参考以下几种”全局”代理工具：</p>
<h1 id="全局代理"><a href="#全局代理" class="headerlink" title="全局代理"></a>全局代理</h1><h2 id="tun2socks"><a href="#tun2socks" class="headerlink" title="tun2socks"></a>tun2socks</h2><p>通过 tun2socks，能够把所有本机应用程序发出的流量都交给 V2Ray&#x2F;SOCKS&#x2F;Shadowsocks，从而达到全局 TCP&#x2F;UDP 代理（对，只是 TCP&#x2F;UDP，ICMP 等等是不支持的，全局性还是不比真正的 VPN）</p>
<p>tun2socks工具：golang实现</p>
<p><a target="_blank" rel="noopener" href="https://github.com/eycorsican/go-tun2socks">https://github.com/eycorsican/go-tun2socks</a></p>
<ul>
<li>Windows：[<a target="_blank" rel="noopener" href="https://tachyondevel.medium.com/%E6%95%99%E7%A8%8B-%E5%9C%A8-windows-%E4%B8%8A%E4%BD%BF%E7%94%A8-tun2socks-%E8%BF%9B%E8%A1%8C%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86-aa51869dd0d">教程] 在 Windows 上使用 tun2socks 进行全局代理</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;hosts&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;domain:www.bilibili.com&quot;</span>: <span class="string">&quot;1.2.3.4&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;dns&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            // VMess outbound</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">                <span class="string">&quot;network&quot;</span>: <span class="string">&quot;udp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;port&quot;</span>: 53,</span><br><span class="line">                <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置中没有 inbound，因为我们所用的 tun2socks 软件：<a target="_blank" rel="noopener" href="https://github.com/eycorsican/go-tun2socks">go-tun2socks</a>本身把 tun2socks 内置为 V2Ray 的一个 inbound 了。</p>
<h2 id="Mellow"><a href="#Mellow" class="headerlink" title="Mellow"></a>Mellow</h2><blockquote>
<p><em><code>go-tun2socks</code> 是一个命令行工具，要使用的话还要自己创建 TUN 接口，配置路由表等，比较繁琐，这里还有另一个应用叫 <a target="_blank" rel="noopener" href="https://github.com/eycorsican/Mellow">Mellow</a> ，对 <code>go-tun2socks</code> 进行了包装，可以自动完成这些繁琐的步骤，实际使用起来的效果就相当于 Proxifier、SSTap、Surge for Mac 等软件，可以把所有流量都代理了：</em></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/mellow-io/mellow">https://github.com/mellow-io/mellow</a></p>
<h2 id="移动端环境"><a href="#移动端环境" class="headerlink" title="移动端环境"></a>移动端环境</h2><p>要代理所有 app 的流量，tun2socks 是一种必须的手段，它们跟桌面系统上用 tun2socks 很相似，都是要把所有的 TCP&#x2F;UDP 流量引导进 V2Ray，但也有不一样的地方，<em>移动端系统一般都提供了特殊的方法，能够让指定的流量不受路由表基于 IP 地址的路由控制</em>。</p>
<p>在移动端系统方面，iOS 既可以像桌面系统用 tun2socks 那样把所有 TCP&#x2F;UDP 流量引导到 V2Ray，也可以设置一个 <strong>HTTP 代理</strong>把 HTTP 请求代理到 V2Ray 的 HTTP inbound 里；而 Android，只能以 tun2socks 那样的方式把 TCP&#x2F;UDP 流量引导进去。</p>
<p>iOS 的 HTTP&#x2F;S 代理跟 SOCKS5 代理比较相似，应用程序不需要自己解析 DNS，可以把域名带上交给 V2Ray，然后如果请求匹配到代理的路由规则，这个域名就通过代理协议（VMess&#x2F;Shadowsocks&#x2F;SOCKS5）交给代理服务器自己去解析，所以本地不需要做任何 DNS 解析。问题是很明显这个只适用于 HTTP&#x2F;S 请求（而且并不是所有的 HTTP&#x2F;S 请求，貌似应用程序还必须要用 iOS 系统提供的 HTTP 库来做请求才会被代理到）。</p>
<p>再考虑到 Android 并不能很自然地支持 HTTP&#x2F;S 或者 SOCKS5 代理，所以想要一个通用的解决方案，还是要从 TCP&#x2F;UDP 流量入手。kitsunebi软件内置了go-tun2socks和V2Ray核心，能够将所有本地TCP&#x2F;UDP流量引导到V2Ray代理链上：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/eycorsican/kitsunebi-android">https://github.com/eycorsican/kitsunebi-android</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;hosts&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;domain:www.bilibili.com&quot;</span>: <span class="string">&quot;1.2.3.4&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;114.114.114.114&quot;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;address&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;domains&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;google&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;port&quot;</span>: 53</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">            <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;proxy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">            <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;dns&quot;</span>,</span><br><span class="line">         <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;inboundTag&quot;</span>: [<span class="string">&quot;tun2socks&quot;</span>],</span><br><span class="line">                <span class="string">&quot;network&quot;</span>: <span class="string">&quot;udp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;port&quot;</span>: 53,</span><br><span class="line">                <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;dns-out&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;8.8.8.8/32&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置中的 inboundTag tun2socks 是必须的，虽然单凭 53 端口 和 network udp 大致达到识别出 UDP 流量的目的，但因为在 V2Ray 中 UDP 流量并不只从 tun2socks inbound 进来，还会从 内置 DNS 那边过来，如果不加上 inboundTag tun2socks 这个限制，内置 DNS 那边过来的流量就会被转到 DNS outbound，接着有可能又被转给 内置 DNS，造成环路。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="Fake-DNS"><a href="#Fake-DNS" class="headerlink" title="Fake DNS"></a>Fake DNS</h2><p>大体上，从流量流向的角度来看，一般 DNS 处理方式也就 3 种：</p>
<ul>
<li>直接从本机发出 DNS 请求到目的 DNS 服务器</li>
<li>通过代理把 DNS 请求发送到目的 DNS 服务器</li>
<li>本机不向互联网发出 DNS 请求流量（由远端代理服务器来解析或者直接本地伪造 DNS 答复返回）</li>
</ul>
<p>虽然现在已经可以完全利用 V2Ray 的 DNS 功能模块对 DNS 的 UDP 流量做各种处理，可以对 DNS 请求按域名做分流，但仔细想想，分流时不管是发到 freedom outbound 直连还是发到 VMess outbound 代理，这些 DNS 请求终究是要以实际的流量形式从本地发送到互联网上，是否有方法可以在利用 tun2socks 获取所有 TCP&#x2F;UDP 流量的同时，又可以像 HTTP&#x2F;S 和 SOCKS5 代理那样，本地完全不发出 DNS 请求流量，只把域名交给代理服务器，让代理服务器自己去解析呢？</p>
<p>答案是有的，那就是 Fake DNS，Fake DNS 是有一个 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3089">RFC</a> 的，某些使用 iOS 的读者可能也并不陌生，Surge 中的 <code>force-remote-dns</code> 就是利用了这种技术。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 手机上某个 app 想发出 &lt;https://www.google.com&gt; 请求</span><br><span class="line">2. app 发出 www.google.com 的 DNS 查询</span><br><span class="line">3. DNS 请求的 UDP 流量来到 tun2socks，被 tun2socks 交到 Fake DNS 模块</span><br><span class="line">4. Fake DNS 模块选择一个伪造的 IP 地址，比如 244.0.0.3，并把这个地址跟 www.google.com 关联起来</span><br><span class="line">5. Fake DNS 根据 DNS 请求，生成相应的 DNS 答复，并把 244.0.0.3 当作 DNS 结果放进答复中，通过 tun2socks 把这个伪造的 DNS 答复返回给 app</span><br><span class="line">6. app 得到 www.google.com 的 DNS 查询结果是 244.0.0.3</span><br><span class="line">7. app 向 244.0.0.3 发出 HTTP 请求流量</span><br><span class="line">8. HTTP 请求流量来到 tun2socks，tun2socks 向 Fake DNS 模块查询目的地址 244.0.0.3 是否是一个伪造的 IP 地址，如果是，向 Fake DNS 查询这个 IP 所关联的 域名，也即 www.google.com</span><br><span class="line">9. tun2socks 现在已经得到 HTTP 请求流量的域名，把流量以及域名一并交给 V2Ray</span><br><span class="line">10. V2Ray 有了域名，接下来路由什么的该怎么处理就怎么处理了</span><br></pre></td></tr></table></figure>

<p>上面过程中，虽然 app 是发出了 DNS 请求流量，但这个流量被拦截下来了，并没有真正地发到互联网上；最终 V2Ray 也拿到了域名，如果这个域名匹配到代理规则，就会交到代理服务器来解析，也就是所谓的 远程 DNS 解析。</p>
<p>上面过程中，Fake DNS 模块如果没有对域名做过滤，对任何域名都返回伪造的 IP 地址，则可能会引起一些问题，有一种做法是在 Fake DNS 模块里内置一个域名列表，只对匹配到列表的域名返回 伪造 DNS 答复。</p>
<p>Fake DNS 不管是原理上还是实现上都是非常简单的，如果有兴趣可以看一下 <a target="_blank" rel="noopener" href="https://github.com/eycorsican/leaf/blob/master/leaf/src/app/fake_dns.rs">这里的实现代码</a>。</p>
<h2 id="DOH"><a href="#DOH" class="headerlink" title="DOH"></a>DOH</h2><p>在中国大陆可以使用阿里云 DNS 提供的 DoH 服务解析境内域名：<code>https://dns.alidns.com/dns-query</code>或 <code>https://223.5.5.5/dns-query</code> 。一般在远端配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">     <span class="string">&quot;https+local://1.1.1.1/dns-query&quot;</span>,</span><br><span class="line">     <span class="string">&quot;localhost&quot;</span></span><br><span class="line">   ]</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DOH 服务商不像传统 DNS 那么成熟，目前网上提供 DOH 的服务商可以参考 <strong><a target="_blank" rel="noopener" href="https://github.com/curl/curl/wiki/DNS-over-HTTPS">curl - DNS over HTTPS</a></strong></p>
<p>DOH 把 DNS 请求融入到常见的 https 流量当中，完全使用 DOH 可以避免出入口 ISP 知道你访问的域名。 但需要注意，只有在客户端、服务端都使用 DOH 协议（客户端使用 https 模式，服务端使用 https+local 模式）时候，VPS 出口上才不会出现传统的 UDP DNS 请求。</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/01/06/2022-01-06-%E3%80%90%E7%A0%94%E4%BA%8C%E4%B8%8A%E3%80%91%E5%8F%91%E7%8E%B0%E8%A1%A8%E6%A0%BC%E5%9E%8B%E6%95%B0%E6%8D%AE%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2022-03-31 16:00:00
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="计算机网络">
                        <b>#</b> 计算机网络
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/proxy/" title="proxy">
                        <b>#</b> proxy
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/DNS/" title="DNS">
                        <b>#</b> DNS
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/04/02/2022-04-02-TLS/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%83%85%E5%A2%83"><span class="toc-text">使用情境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BF%E5%91%8A%E5%B1%8F%E8%94%BD"><span class="toc-text">广告屏蔽</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E5%88%AB%E5%90%8D"><span class="toc-text">域名别名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS%E6%9F%A5%E8%AF%A2%E5%88%86%E6%B5%81"><span class="toc-text">DNS查询分流</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DNS%E4%BD%BF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">DNS使用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E4%BB%A3%E7%90%86"><span class="toc-text">未代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SOCK5%E4%BB%A3%E7%90%86"><span class="toc-text">SOCK5代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9"><span class="toc-text">路由选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AEDNS"><span class="toc-text">内置DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hosts"><span class="toc-text">hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#servers"><span class="toc-text">servers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS-Outbound"><span class="toc-text">*DNS Outbound*</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PC%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-text">PC端使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF"><span class="toc-text">移动端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86"><span class="toc-text">全局代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tun2socks"><span class="toc-text">tun2socks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mellow"><span class="toc-text">Mellow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%8E%AF%E5%A2%83"><span class="toc-text">移动端环境</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fake-DNS"><span class="toc-text">Fake DNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DOH"><span class="toc-text">DOH</span></a></li></ol></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        






  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

  <div id="gitalk-container"></div>

  <script>
    const gitalk = new Gitalk({
      clientID: '5701baa041ba27d28c94',
      clientSecret: '87f7280a5901e8c3d5f84bd9ee65f993bdf43640',
      repo: 'juaran.github.io',
      owner: 'Juaran',
      admin: ['Juaran'],
      id: decodeURI(location.pathname),
      distractionFreeMode: false
    })

    gitalk.render('gitalk-container')
  </script>


      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/juaran">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/juaran">Copyright © 2022 Vic2ray</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        


        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        

      </div>
    </div>
  </body>
</html>
