---

title: 后台管理系统适配前端页面
date: 2021-1-17
category: 研一上周报

---

## 项目目标

1. 将若依后台管理系统的Oracle数据库版本的前端页面更换为若依-Layui项目的前端页面；
2. 按需求新增站点管理，其他表按需增加字段；
3. 前端页面适配IE8浏览器。

<!-- more -->

### 一、项目地址

- **RuoYi-Oracle**：https://github.com/yangzongzhuan/RuoYi-Oracle

若依后台管理系统Oracle版本。

- **ruoyi-layui**：https://gitee.com/flying_stars/ruoyi-layui

结合`RuoYiPlus`项目在`RuoYi`项目基础上改造成layui版本。

### 二、Oracle数据库

数据库地址：https://github.com/yangzongzhuan/RuoYi-Oracle/tree/master/sql

1. [ry_20201214.sql  ](https://github.com/yangzongzhuan/RuoYi-Oracle/blob/master/sql/ry_20201214.sql)主要数据
2. [quartz.sql    ](https://github.com/yangzongzhuan/RuoYi-Oracle/blob/master/sql/quartz.sql)定时任务数据

#### Docker安装Oracle

由于甲骨文数据库商用收费，个人使用免费，在DockerHub中并没有直接可用的Oracle镜像，要么自己手动安装制作镜像，要么使用个人制作好的.

1. 下载镜像：

``` shell
docker pull registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g
```

注：oracle_11g是Oracle数据库的版本号11g。

2. 启动容器：

``` shell
docker run -it -d -p 1521:1521 --name juneoracle registry.cn-hangzhou.aliyuncs.com/helowin/oracle_11g
```

3. 配置容器：

``` shell
docker exec -it juneoracle bash	// 进入容器
su root 	// 切换至root，密码helowin
vi /etc/profile		// 配置环境变量

export ORACLE_HOME=/home/oracle/app/oracle/product/11.2.0/dbhome_2
export ORACLE_SID=helowin
export PATH=$ORACLE_HOME/bin:$PATH

source /etc/profile		// 生效
ln -s $ORACLE_HOME/bin/sqlplus /usr/bin		// 软连接
su - oracle	// 切换用户
sqlplus /nolog	// 连接数据库

conn /as sysdba
alter user system identified by 123456;		// system密码
alter user sys identified by 123456;	// sys密码
create user root identified by 123456;	// 创建用户
grant connect,resource,dba to root;		// 授权
alter profile default limit PASSWORD_LIFE_TIME UNLIMITED;	// 密码不过期

conn /as sysdba		// 重启数据库
shutdown immediate;
startup;
exit
```

参考：https://my.oschina.net/u/4396922/blog/4535903

Navicat连接信息：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019161547143.png" alt="image-20211019161547143" style="zoom: 80%;" />

4. 运行sql文件，创建表

### 三、页面移植

Idea导入Ruoyi-Oracle项目，安装Maven相关依赖。

#### 3.1 配置数据源

> \ruoyi-admin\src\main\resources\application-druid.yml

``` yaml
# 主库数据源
master:
url: jdbc:oracle:thin:@172.17.171.8:1521/helowin
    username: root
    password: 123456
```

修改为Oracle数据库的连接地址、服务名、用户名、密码。

#### 3.2 替换前端页面

前端页面模板及静态资源文件主要位置：

1. \ruoyi-admin\src\main\resources\static
2. \ruoyi-admin\src\main\resources\template

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019161803376.png" alt="image-20211019161803376" style="zoom:67%;" />

- 删除这两个文件夹，替换为ruoyi-layui项目的对应目录文件夹。

重新登录，index页面报错：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019161828654.png" alt="image-20211019161828654" style="zoom:67%;" />

查看报错信息：

![img](https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/a9ee1818-b5c6-40fb-a6d7-55bb056400d0.png)

全局搜索：com.ruoyi.web.utils.UserUtils

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/45c9cb92-0dea-48d9-93f9-ddccec490410.png" alt="img" style="zoom: 67%;" />

这两个页面引用了 UserUtils 包。在ruoyi-layui 项目复制这个包到对应目录下，并解决相关依赖问题：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019164009447.png" alt="image-20211019164009447" style="zoom: 67%;" />

重新运行项目，便可以登录进入首页。

#### 3.3 用户管理

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/416d8620-5580-45c2-9e1b-15c9c08d104b.png" alt="img" style="zoom: 50%;" />

查看请求数据接口：

1. /system/user/list
2. /system/dept/treeData2

先解决用户列表接口问题。启动ruoyi-layui,查看对应返回数据接口返回数据，与之对比：

![img](https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/6f864d2e-982d-42ff-ae9c-f4d1b8a5f0e2.png)![img](https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/cc513f19-24ba-4484-9b66-f7b637cc4941.png)

对比发现：返回rows字段应对应data、total字段应对应count。

定位到用户管理页面：\ruoyi-admin\src\main\resources\templates\system\user\user.html

定位到user表格渲染位置，在render函数末尾增加layui表格数据解析：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/eed2331c-5bac-4f7d-aed1-f0b18a054bc3.jpg" alt="img" style="zoom:67%;" />

``` java
,parseData: function(res){ //res 即为原始返回的数据
    return {
        "code": res.code, //解析接口状态
        "msg": res.msg, //解析提示文本
        "count": res.total, //解析数据长度
        "data": res.rows //解析数据列表
    };
}
```

这样使得后台返回数据对应表格渲染数据字段，页面成功展示：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/1776d528-7066-4ffb-bf3c-85e19fb1b8f2.png" alt="img" style="zoom:50%;" />

接下来解决/system/dept/treeData2接口。定位到SysDeptController，/treeData路由：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/8eef843a-1a79-44da-8bfc-c2a09a81327b.jpg" alt="img" style="zoom: 67%;" />

而请求的路由地址为：/treeData2。在ruoyi-layui项目对应位置查找，发现以下路由方法：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/dc6da759-b03c-4221-9315-1a62c5fadf17.png" alt="img" style="zoom:67%;" />

可以看出改方法在treeData的基础上进行**EleTreeWrapper**封装，并加入code、data字段。复制该路由方法到Oracle项目，并引入EleTreeWrapper包，与controller包同级：

![img](https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/e19edb2d-88e8-48c7-9887-13ba20d44866.png)

发现deptService.selectDpetTree方法返回值类型不匹配：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/837fd604-ea95-4f2a-96d1-e27e06b73290.png" alt="img" style="zoom:67%;" />

定位到接口：ISysDeptService，在selectDeptTree下新增方法**selectDeptTreee**：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/79b3b4dc-a5f7-40e9-b332-013854579278.jpg" alt="img" style="zoom:67%;" />

在接口实现类SysDeptServiceImpl中selectDeptTree下方添加该方法，只需要将ruoyi-layui中对应方法复制过来即可，注意getTrees方法也要复制：

``` java
@Override
@DataScope(deptAlias = "d")
public List<Map<String, Object>> selectDeptTreee(SysDept dept)
{
    List<Map<String, Object>> trees = new ArrayList<Map<String, Object>>();
    List<SysDept> deptList = deptMapper.selectDeptList(dept);
    trees = getTrees(deptList, false, null);
    return trees;
}
```

Controller的treeData2方法内调用新的函数**selectDeptTreee**。重新运行项目，用户管理页面已经生效：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/19e14be4-7293-4987-bf89-32839c206709.png" alt="img" style="zoom:67%;" />

#### 3.4 角色管理

页面同样不显示，发现与前面/system/user/list接口一样，返回数据类型解析不一致所致。

定位到前端页面：\ruoyi-admin\src\main\resources\templates\system\role\role.html定位到表格渲染位置：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/6a794980-8d7c-41c3-beae-1b898f941e68.jpg" alt="img" style="zoom:67%;" />

末尾增加解析： 

```java
,parseData: function(res){ //res 即为原始返回的数据
    return {
        "code": res.code, //解析接口状态
        "msg": res.msg, //解析提示文本
        "count": res.total, //解析数据长度
        "data": res.rows //解析数据列表
    };
}
```

页面数据表格渲染成功：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019162305612.png" alt="image-20211019162305612" style="zoom:67%;" />

最后，角色-部门**数据权限列表树**部分需要修改。

定位请求为：/system/role/rule/1，页面是：\ruoyi-admin\src\main\resources\templates\system\role\role.html。

定位到SysRoleController，查找/rule相关路由方法（为角色增加数据权限），发现与之相似的是/authDataScope路由，看来是做了新的实现。这里依旧复制ruoyi-layui对应位置的/rule路由相关代码到项目中。

```java
/**
 * 新增数据权限
 */
@GetMapping("/rule/{roleId}")
public String rule(@PathVariable("roleId") Long roleId, ModelMap mmap)
{
    mmap.put("role", roleService.selectRoleById(roleId));
    return prefix + "/rule";
}

/**
 * 修改保存数据权限
 */
@RequiresPermissions("system:role:edit")
@Log(title = "角色管理", businessType = BusinessType.UPDATE)
@PostMapping("/rule")
@Transactional(rollbackFor = Exception.class)
@ResponseBody
public AjaxResult ruleSave(SysRole role)
{
    role.setUpdateBy(ShiroUtils.getLoginName());
    return toAjax(roleService.updateRule(role));
}
```

发现roleService.updateRule方法报红，添加相应方法接口及实现。ISysRoleService：

```java
/**
 * 修改数据权限信息
 *
 * @param role 角色信息
 * @return 结果
 */
public int updateRule(SysRole role);
```

SysRoleServiceImpl实现方法：

```java
/**
 * 修改数据权限信息
 * 
 * @param role 角色信息
 * @return 结果
 */
@Override
public int updateRule(SysRole role)
{
    // 修改角色信息
    roleMapper.updateRole(role);
    // 删除角色与部门关联
    roleDeptMapper.deleteRoleDeptByRoleId(role.getRoleId());
    // 新增角色和部门信息（数据权限）
    return insertRoleDept(role);
}
```

解决了角色权限后，还需要解决部门角色对应关系。复制ruoyil-ayui下的SysDeptController的/roleDeptTreeData2路由方法到/roleDeptTreeData后面：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/c2874ee7-c531-47c4-84ae-ece3e0eb5356.jpg" alt="img" style="zoom:67%;" />

报红，同样需要添加Map<String, Object>类型的方法。定位到接口实现类ISysDeptService，在roleDeptTreeData下新增方法：roleDeptTreeData2

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/d130e47c-fb48-4901-8704-47e5a305045e.jpg" alt="img" style="zoom:67%;" />

并在实现类SysDeptServiceImpl中实现该方法：

``` java
@Override
public List<Map<String, Object>> roleDeptTreeData2(SysRole role)
{
    Long roleId = role.getRoleId();
    List<Map<String, Object>> trees = new ArrayList<Map<String, Object>>();
    List<SysDept> deptList = selectDeptList(new SysDept());
    if (StringUtils.isNotNull(roleId))
    {
        List<String> roleDeptList = deptMapper.selectRoleDeptTree(roleId);
        trees = getTrees(deptList, true, roleDeptList);
    }
    else
    {
        trees = getTrees(deptList, false, null);
    }
    return trees;
}
```

在原Controller内调用方法改为roleDeptTreeData2，数据权限页面添加成功：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/22bd30ff-3d27-426a-984e-236a1eed8d03.png" alt="img" style="zoom:67%;" />

#### 3.5 菜单管理

菜单页面显示不出来，查看接口：/system/menu/listTreeGridData

定位到SysMenuController发现并没有对应的listTreeGridData路由方法，在ruoyi-layui项目中找到对应路由函数，复制到list路由函数下：

``` java
@RequiresPermissions("system:menu:list")
@GetMapping("/listTreeGridData")
@ResponseBody
public Map listTreeGridData(SysMenu menu) {
    Map retMap = new HashMap();
    Long userId = ShiroUtils.getUserId();
    List<SysMenu> menuList = menuService.selectMenuList(menu, userId);
    retMap.put("msg", "");
    retMap.put("code", 0);
    retMap.put("data", menuList);
    retMap.put("count", menuList != null ? menuList.size() : 0);
    retMap.put("is", true);
    retMap.put("tip", "操作成功");
    return retMap;
}
```

注意参照原/list函数需要在selectMenuList方法内添加userId参数。最终页面显示完成：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/5863f355-fd4c-4e9f-8b0d-330593e73792.png" alt="img" style="zoom:67%;" />

#### 3.6 部门管理

部门管理的处理方法与菜单管理页面相同。在SysDeptController的/list路由下增加/listTreeGridData：

``` java
@RequiresPermissions("system:dept:list")
@GetMapping("/listTreeGridData")
@ResponseBody
public Map listTreeGridData(SysDept dept)
{
    Map retMap = new HashMap();
    List<SysDept> deptList = deptService.selectDeptList(dept);
    retMap.put("msg","");
    retMap.put("code",0);
    retMap.put("data",deptList);
    retMap.put("count",deptList!=null?deptList.size():0);
    retMap.put("is",true);
    retMap.put("tip","操作成功");
    return retMap;
}
```

其次，替换新增部门/add路由方法，解决当选择部门为0时的错误，改为默认添加到主部门：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/13dc2c92-e43e-449b-af56-6db04aafd65e.jpg" alt="img" style="zoom:67%;" />

部门管理页面迁移成功：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/27324497-1ec5-4fae-9d4f-59c2caffcfb5.png" alt="img" style="zoom:67%;" />

#### 3.7 其余页面

- 岗位管理：post页面。接口解析更换即可。

- 字典管理：dict页面。更换接口解析。注意data/type两个页面都要解析。
- 参数设置：config页面。
- 通知公告：notice页面。
- 登录日志：/monitor/logininfor/logininfor.html
- 操作日志：/monitor/operlog/operlog.html
- 在线用户：/monitor/online/online.html  
- 定时任务：/monitor/job/job.html  
- 代码生成：/tool/gen/gen/gen.html和importTable页面

### 四、新增功能

#### 4.1 新增站点

站点信息表建表sql语句：

``` mysql
-- ----------------------------
-- 站点信息表
-- ----------------------------
create sequence seq_sys_site
 increment by 1
 start with 100
 nomaxvalue
 nominvalue
 cache 20;

create table sys_site (
  site_id           number(20)      not null,
  site_name         varchar2(30)    not null,
	site_desc         varchar2(100),
	site_url         	varchar2(100) not null,
	site_img         	varchar2(100) not null,
  site_sort         number(4)       not null,
  status            char(1)         not null,
	site_type 				varchar2(30)    not null,
  create_by         varchar2(64)    default '',
  create_time       date,
  update_by         varchar2(64)    default '',
  update_time       date
);
```

**使用代码生成器（注意需要使用Orcel原版工程的代码生成器，layui版本生成器是mysql数据格式）**下载代码，复制到项目对应位置。注意template页面不需要。

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/00668fb5-6f6a-41ab-bf5f-8e23f5021ce4.png" alt="img" style="zoom: 80%;" /><img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/39a85586-1e6b-4f01-85af-00b1e39f359b.png" alt="img" style="zoom:67%;" />

点击菜单管理页面，在系统管理栏目下新增站点管理菜单：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/bf6fee0a-bf55-45c4-8e15-a88f5160cfa1.png" alt="img" style="zoom:67%;" />

在template页面模板下，复制一份post岗位页面的代码，改文件夹名称为site；

重命名post.html为site.html，搜索全部post字符串替换为site，注意post提交不要变；

更改页面header为站点管理；更改搜索框名称及name属性：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/3a9a6aa5-5356-4ff1-9938-afb1a23ace84.png" alt="img" style="zoom:67%;" />

重新编辑table.render内的表格cols列字段为site表的字段属性：

``` mysql
, cols: new Array([
    {type: 'checkbox', width: 40}
    , {field: 'siteName', title: '站点名称', width: 100}
    , {field: 'siteDesc', title: '站点描述', width: 100}
    , {field: 'siteUrl', title: '站点地址', width: 160}
    , {field: 'siteImg', title: '站点图标', width: 160}
    , {field: 'siteType', title: '站点类型', width: 80}
    , {field: 'siteSort', sort: true, width: 100, title: '显示顺序'}
    , {
        field: 'status', width: 80, title: '状态',
        templet: function (item) {
            if (item.status === "0") {
                return "<span class=\"layui-btn layui-btn-xs layui-btn-radius\">正常</span>";
            } else {
                return "<span class=\"layui-btn layui-btn-xs layui-btn-danger layui-btn-radius\">停用</span>";
            }
        }
    }
    , {field: 'createBy', title: '创建者'}
    , {field: 'createTime', title: '创建时间', width: 160, sort: true}
    , {field: 'updateBy', title: '更新者'}
    , {field: 'updateTime', title: '更新时间', width: 160, sort: true}
    , {title: '操作', width: 100, toolbar: '#col_operation'}
])
```

清理Maven缓存，重启项目，进入站点菜单，测试增查询操作：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/d31ace54-d4b8-414c-80ab-9e576cdfde6f.png" alt="img" style="zoom:67%;" />

接下来修改编辑页edit.html：
搜索替换post为site；发现引用了/js/system/site_form.js，复制post_form.js改名为site_form.js，同样替换post为site；

然后再仔细编辑edit页面中的表单字段，注意form获取对象为**sysSite**：

``` html
<form class="layui-form mt20" lay-filter="form-site" th:object="${sysSite}">
        <input id="siteId" name="siteId" type="hidden" th:field="*{siteId}"/>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点名称：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteName" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" th:field="*{siteName}"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点描述：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteDesc" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" th:field="*{siteDesc}"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点地址：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteUrl" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" th:field="*{siteUrl}"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点图标：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteImg" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" th:field="*{siteImg}"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点类型：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteType" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" th:field="*{siteType}"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>显示顺序：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteSort" lay-verify="required|number" lay-verType="tips" laceholder="" autocomplete="off" th:field="*{siteSort}"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">站点状态：</label>
            <div class="layui-input-block">
                <span th:each="dict : ${@dict.getType('sys_normal_disable')}">
                    <input type="radio" th:id="${dict.dictCode}" name="status" th:value="${dict.dictValue}" th:title="${dict.dictLabel}" th:field="*{status}" />
                </span>
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="btn-edit" id="btn-edit">保存</button>
            </div>
        </div>
    </form>
```

最后需要添加数据更新者的用户名。在SysSiteController的/edit路由方法返回数据前添加：

```java
sysSite.setUpdateBy(ShiroUtils.getLoginName());
```

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/91a4ec4e-8778-4b7b-82c3-2d9707532f17.png" alt="img" style="zoom:67%;" />

接下来是add.html，替换为site字符串，然后替换table内容：

``` html
<form class="layui-form mt20" lay-filter="form-site">
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点名称：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteName" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点描述：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteDesc" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点地址：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteUrl" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点图标：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteImg" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" />
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>站点类型：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteType" lay-verify="required" lay-verType="tips" placeholder="" autocomplete="off" />
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"><span class="required-msg ">*</span>显示顺序：</label>
            <div class="layui-input-block">
                <input class="layui-input min-input" type="text" name="siteSort" lay-verify="required|number" lay-verType="tips" laceholder="" autocomplete="off" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">站点状态：</label>
            <div class="layui-input-block">
                <span th:each="dict : ${@dict.getType('sys_normal_disable')}">
                    <input type="radio" th:id="${dict.dictCode}" name="status" th:value="${dict.dictValue}" th:title="${dict.dictLabel}" />
                </span>
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="btn-add" id="btn-add">保存</button>
            </div>
        </div>
    </form>
```

在增加时，还需要设置自增字段siteId，否则会插入空值错误。在SysSiteMapper.xml的insertSysSite项中添加属性到insert语句之前：

```XML
<selectKey keyProperty="siteId" order="BEFORE" resultType="Long">
	select seq_sys_site.nextval as siteId from DUAL
</selectKey>
```

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/6cb3cf38-28f3-4801-aff7-02ca0668140a.png" alt="img" style="zoom:67%;" />

至此，站点管理的查询、增加、删除、修改功能已经完成。

#### 4.2 部门表增加类型等级 

- DEPT_TYPE  部门类型
- DEPT_LEVEL  部门等级

首先在Oracle数据库中修改SYS_DEPT表结构，为其增加两个字段；

然后定位到\ruoyi-system\src\main\resources\mapper\system\**SysDeptMapper**.xml

1. 在resultMap标签末尾添加数据库字段和实体属性映射：

   <img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/5e72f960-1fc3-4cf9-bce4-efc1508100b9.png" alt="img" style="zoom:80%;" />

2. 通过搜索**phone**字符串，看有那些操作需要增加这两个字段：

- - selectDeptVo标签，sql语句增加 d.dept_type, d.dept_level
  - selectDeptById标签，语句增加 d.dept_type, d.dept_level
  - insertDept标签，语句末尾增加 insert into(xx) values(xx)

```xml
,
<if test="deptType != null and deptType != ''">dept_type,</if>
<if test="deptLevel != null and deptLevel != ''">dept_level</if>
,
<if test="deptType != null and deptType != ''">#{deptType},</if>
<if test="deptLevel != null and deptLevel != ''">#{deptLevel}</if>
```

- - updateDept标签，末尾增加：    

```xml
,
<if test="deptType != null">dept_type = #{deptType},</if>
<if test="deptLevel != null">dept_level = #{deptLevel}</if>
```

第二步，定位到SysDept实体类：\ruoyi-common\src\main\java\com\ruoyi\common\core\domain\entity\**SysDept**.java

照着phone属性增加这两个字段，并实现其get、set方法：

``` java
/** 联系电话 */
private String phone;

/** 部门类型 */
private String deptType;

/** 部门等级 */
private String deptLevel;
public String getDeptType() { return deptType; }
public String getDeptLevel() { return deptLevel; }
public void setDeptType(String deptType) { this.deptType = deptType; }
public void setDeptLevel(String deptLevel) { this.deptLevel = deptLevel; }
```

第三步，定位到到前端页面 dept/edit.html 和 add.html，在form表单中增加这两个字段的表单控件：

``` html
<div class="layui-form-item">
    <label class="layui-form-label">部门类型：</label>
    <div class="layui-input-block">
        <input class="layui-input min-input" type="text" name="deptType" placeholder="" autocomplete="off" />
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">部门等级：</label>
    <div class="layui-input-block">
        <input class="layui-input min-input" type="text" name="deptLevel" placeholder="" autocomplete="off" />
    </div>
</div>
```

``` html
<div class="layui-form-item">
    <label class="layui-form-label">部门类型：</label>
    <div class="layui-input-block">
        <input class="layui-input min-input" type="text" name="deptType" placeholder="" autocomplete="off" th:field="*{deptType}"/>
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">部门等级：</label>
    <div class="layui-input-block">
        <input class="layui-input min-input" type="text" name="deptLevle" placeholder="" autocomplete="off" th:field="*{deptLevel}"/>
    </div>
</div>
```

至此，部门管理增加两个字段的工作已经完成。在页面中进行增删改查均有效。

#### 4.3 角色表增加角色类型

1. 角色表SYS_ROLE增加ROLE_TYPE字段
2. SysRoleMapper.xml语句增加roleType字段
3. SysRole实体类增加roleType属性和get/set方法
4. template/role/edit.hml和add.html增加roleType表单控件，role.html表单渲染增加roleType字段

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019164648585.png" alt="image-20211019164648585" style="zoom:67%;" />

#### 4.4 岗位表增加站点ID

同以上两个新增字段任务的步骤和方法：

1. 岗位表SYS_POST增加SITE_ID字段
2. SysPostMapper.xml语句增加siteId字段
3. SysPost实体类增加siteId属性和get/set方法
4. template/post/edit.hml和add.html增加siteId表单控件，post.html表单渲染增加siteId字段

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/2c3a1b52-7799-47d4-b5bf-103bbf9717ce.png" alt="img" style="zoom:67%;" />

#### 4.5 用户表增加其他账号

1. 用户表SYS_USER增加OTHER_LOGIN_NAME字段
2. SysUserMapper.xml语句增加otherLoginName字段
3. SysUser实体类增加otherLoginName属性和get/set方法
4. template/user/edit.hml和add.html增加otherLoginName表单控件，user.html表单渲染增加otherLoginName字段
5. <img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/8be3453c-7226-4727-8ae5-c3d6c6c563b4.png" alt="img" style="zoom:67%;" />

#### 4.6 字典管理

在站点管理中，站点状态（status）和站点类型（site_type）两个属性可以关联到数据字典。

切换到字典管理页面，点击**新增sys_site_status数据字典**：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/341fe0d0-033b-4046-834e-2f7e62d4be99.png" alt="img" style="zoom:67%;" />

然后点击站点状态字典单元格右侧**列表数据**，新增字典数据，字典键值0对应站点启用状态，键值1对应站点停用状态：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/fff8a076-706d-490a-807d-29586e551b95.png" alt="img" style="zoom: 67%;" />

<img src="C:/Users/Document/WizNote/temp/7f20dc9c-3687-4b28-ae01-f55e40d54547/128/index_files/331ebd6f-2f62-4f62-8d51-eec83d950c60.png" alt="img" style="zoom:67%;" />

然后在项目template的site/add.html中站点状态对应表单控件中指定类型为数据字典sys_site_status：

``` html
<div class="layui-form-item">
    <label class="layui-form-label">站点状态：</label>
    <div class="layui-input-block">
        <span th:each="dict : ${@dict.getType('sys_site_status')}">
            <input type="radio" th:id="${dict.dictCode}" name="status" th:value="${dict.dictValue}" th:title="${dict.dictLabel}" />
        </span>
    </div>
</div>
```

同样的，在edit.html中站点状态修改为：

``` html
<div class="layui-form-item">
    <label class="layui-form-label">站点状态：</label>
    <div class="layui-input-block">
        <span th:each="dict : ${@dict.getType('sys_site_status')}">
            <input type="radio" th:id="${dict.dictCode}" name="status" th:value="${dict.dictValue}" th:title="${dict.dictLabel}" th:field="*{status}" />
        </span>
    </div>
</div>
```

这样在表单显示、新增、编辑时，站点状态显示为启用或停用两种状态：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/1eca7bdc-d2af-4a4c-a635-ec0ffbdc2799.png" alt="img" style="zoom: 80%;" /><img src="C:/Users/Document/WizNote/temp/7f20dc9c-3687-4b28-ae01-f55e40d54547/128/index_files/89118fff-3772-4c1d-b42f-de8bd1a5f29b.png" alt="img" style="zoom:67%;" />

同样的，为站点类型添加数据字典：**sys_site_type**

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/f468230d-7975-468e-a04a-cc7572c53175.png" alt="img" style="zoom:67%;" />

 增加部门类型数据字典：**sys_dept_type**

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/7be2f294-5c42-4d53-8600-d6e770b5e494.png" alt="img" style="zoom:67%;" />

增加部门等级数据字典：**sys_dept_level**

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/c3d1c9a5-6568-4688-a4c5-d6afe1d0955f.png" alt="img" style="zoom:67%;" />

增加角色类型数据字典： 

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/367d2cfd-0f1d-46bf-bd5e-7d9525c4be66.png" alt="img" style="zoom:67%;" />

#### 4.7 删除若依相关

- 点击菜单管理，找到“**若依官网**”菜单，编辑-隐藏；
- 定位到template/inc/top.html页面，修改Ruoyi-Layui站点名称；

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/7a00f2ba-4490-4103-8f75-dcba20060119.png" alt="img" style="zoom:67%;" />

- 定位到templates/js/index.js在添加tab方法addTab()末尾添加以下代码，解决Tab点击无法切换问题：

```javascript
// 解决Tab无法切换
$('#tabs_content .tabsbody-item').removeClass('layui-show');
$('#tabs_content iframe[data-id="' + id + '"]').parent().addClass('layui-show');
```

- 隐藏**表单构建**菜单；
- 修改**README.md**说明文档。

#### 4.8 增加首页内容

登录后进入首页，默认没有切换Tab标签，首页显示内容为空。定位到index.html的layui-body容器下，增加类名为welcome的子容器。

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/878c65df-d21c-4b4f-a9f6-eab39f02a0aa.png" alt="img" style="zoom:67%;" />

### 五、适配IE8

（云飞工作部分...）

#### 5.1 用户管理适配栅格布局

左侧部门展开树用到扩展模块eleTree.js，对代码中的forEach进行for i 循环转换；

定位到user.html。cdn引用两个js文件：

``` javascript
<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
```

下载到本地进行引用：在js目录下新建 html5.min.js 和 respond.min.js，在user.html头部引用：

```javascript
<script th:src="@{/js/html5.min.js}"></script>
<script th:src="@{/js/respond.min.js}"></script>
```

用户管理页面兼容成功：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/88870cf9-7059-4078-8bb0-cace5a46c9d8.png" alt="img" style="zoom:67%;" />

#### 5.2 菜单部门页面树表

~~用到扩展模块treeTable.js，使用可以兼容IE8浏览器树形展开表格的扩展组件treeTable：~~

~~代码地址：https://fly.layui.com/extend/treeTable/
~~

~~将原来的treeTable模块替换为该模块，并做相应的兼容性修改。~~

- JSON.stringify()等不支持

IE8没有JSON函数，手动添加json2.js到js目录下，下载地址：

https://github.com/douglascrockford/JSON-js/edit/master/json2.js

然后在dept.html和menu.html页面table.render()之前添加：

``` javascript
<!-- 增加IE8对JSON的兼容 -->
<script th:src="@{/js/json2.js}"></script>
```

- forEach()语法不支持

在treeTable.js代码前面添加forEach转for循环：

``` javascript
if (!Array.prototype.forEach) {
   Array.prototype.forEach = function forEach(callback, thisArg) {
      var T, k;
      if (this == null) {
         console.log(1);
         throw new TypeError("this is null or not defined");
      }
      var O = Object(this);
      var len = O.length >>> 0;
      if (typeof callback !== "function") {
         console.log(2)
         throw new TypeError(callback + " is not a function");
      }
      if (arguments.length > 1) {
         T = thisArg;
      }
      k = 0;
      while (k < len) {
         var kValue;
         if (k in O) {
            kValue = O[k];
            callback.call(T, kValue, k, O);
         }
         k++;
      }
   };
}
```

- 树表高度坍缩

经过以上两步处理后，IE8浏览器中菜单部门两个页面的数表结构不再报错，数据成功渲染，但是高度只有一行单元格的高度：

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/5f22220c-5ecf-4c93-9cb2-e4104256dba7.png" alt="img" style="zoom:67%;" />

在表格渲染内设置height属性，这里暂时设置为固定高度500px，后续再做优化。

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/960a1fed-0ccf-4e9e-b8e3-692cfb81dc95.png" alt="img" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/juaran/juaran.github.io@image/typora/image-20211019165423943.png" alt="image-20211019165423943" style="zoom:67%;" />

至此，兼容IE8的主要问题基本解决。

### 六、工作进度

项目地址：https://gitee.com/juaran/ruoyi-oracl-layui

完成功能（截止2021/01/17）:

1. 若依Layui前端页面移植到若依Oracle版本
2. 树形表格兼容IE8浏览器
3. 按照需求增加了站点管理菜单和CRUD、部门管理增加部门类型和部门等级属性

未完成功能：

- 人员部门岗位关系（涛哥接管）
- 人员表增加绑定账号属性、岗位表增加站点ID属性、角色表增加站点ID和角色类型属性（未涉及其他关联关系，按照部门添加属性的方法即可完成）
- 岗位角色关系表（需要参照已有角色部门表ROLE_DEPT的实现）