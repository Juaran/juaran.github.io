---
title: 【国家中小学智慧教育平台】登录逆向分析
date: 2022-07-25 18:00:11
tags: js逆向
---

## 网址

主页：[https://www.zxx.edu.cn/](https://www.zxx.edu.cn/)

登录页：[主页点击登录后跳转](https://www.zxx.edu.cn/uc?sdp-app-id=e5649925-441d-4a53-b525-51a2f1c4e0a8&redirect_uri=https://www.zxx.edu.cn/&send_uckey=true&re_login=false#/login)

## 登录

打开Chrome控制台，点击登录，主要有tokens和sessions两个登录相关请求。

## tokens

```json
// XHR
https://uc-gateway.ykt.eduyun.cn/v1.1/tokens

// Request Payloads
{
    "session_id":"fb6415e7-7c24-4bdc-9c20-63ad559c636a",
    "login_name":"QyuZxQzriIw=",
    "password":"t3qwTIiA52m4X2cKIlVIqqIJb4GxKXobk4QiTzYb3bZxrnYtqNcymw=="
}

// Response - 400
{
    "host_id":"uc-gateway.ykt.eduyun.cn",
    "request_id":"uc-gateway-172.16.1.166^1658675894783^13325",
    "server_time":"2022-07-25T14:23:36.294+08:00",
    "code":"UC/PASSWORD_NOT_CORRECT",
    "message":"用户名或密码错误"
}
// Response - 201
{
	"account_type": "org",
	"account_id": "",
	"user_id": "x",
	"access_token": "x",
	"refresh_token": "x",
	"mac_algorithm": "hmac-sha-256",
	"mac_key": "x",
	"expires_at": "2022-08-01T14:34:10.865+0800",
	"server_time": "2022-07-25T14:34:10.872+0800",
	"region": "wx",
	"source_token_account_type": "person",
	"login_name_type": "mobile",
	"password_change_regularly_claim": 0,
	"weak_pwd": false
}
```

这是一个Content-Type为`application/json`的POST跨域请求。加密字段只有用户名和密码。

## sessions

在所有网络请求中搜索`session_id`，发现第一次出现在tokens前发出的请求sessions：

```json
// XHR
https://uc-gateway.ykt.eduyun.cn/v1.1/sessions

// Request Payloads
{
    "device_id":"dwWin7/Chrome100/03a2b204-f1c2-4243-a338-a1a9e881304a"
}

// Response
{
    "session_id":"155a8167-fd8c-46d0-b536-0ed9b53ee8c2",
    "session_key":"l26ZK0Oy",
    "is_normal":true
}
```

请求返回了`session_id`和`session_key`，用于标识不同客户端。

全局搜索`session_id`，找到AJAX请求代码：

```javascript
t.createSession = function() {
    var e = this;
    return this.headerManager.getDeviceID().then(function(t) {
        return e.request.post({
            url: "".concat(e.UC, "/v1.1/sessions"),
            data: {
                device_id: t
            }
        })
    })
}
```

可见`device_id`由函数`getDeviceID`生成。找到该函数：

```javascript
return t.getDeviceID = function() {
    var e = this;
    return this.fetchDeviceId().then(function(t) {
        if (!t) {
            var n = "".concat(Object(u.c)("/"), "/").concat(Object(c.a)());
            t = "".concat(Object(u.b)(n), "w").concat(n)
        }
        return e.storage.set(d.d, t),
        t
    })
}
```

此函数的逻辑是，调用`fetchDeviceId`，如果结果非空则在本地`storage.set`存储，为空则生成后存储。我们查看浏览器本地存储，发现存在以下键值：

```json
ND_UC_DEVICE_ID: {"value":"dwWin7/Chrome100/03a2b204-f1c2-4243-a338-a1a9e881304a"}
```

其值正是session请求中的device_id。查看fetchDeviceId函数：

```javascript
t.fetchDeviceId = function() {
    var e = this;
    return this.options.deviceId ? Promise.resolve(this.options.deviceId) : this.options.mode === d.f.APPFACTORY ? f.a.getDeviceId().catch(function() {
        return e.storage.get(d.d)
    }) : Promise.resolve(this.storage.get(d.d))
}
```

主要逻辑是`storage.get`获取已有的device_id。那么我们只需要关注其生成逻辑。

## device_id

前文我们已经找到了当本地没有存储device_id时的生成代码：

```javascript
if (!t) {
    var n = "".concat(Object(u.c)("/"), "/").concat(Object(c.a)());
    t = "".concat(Object(u.b)(n), "w").concat(n)
}
```

一共分为两个字符串拼接过程。我们在此处断点，以更好的观察值。同时对照已经生成的值进行快速推断`dwWin7/Chrome100/03a2b204-f1c2-4243-a338-a1a9e881304a`。

第一个过程：`Object(u.c)("/")`将产生字符串`Win7/Chrome100`，随后连接`/`，`Object(c.a)()`是类似uuid的32位随机值。

第二个过程，将以上产生的结果传入`Object(u.b)(n)`得到单个字符`d`，再拼接`w`，最后再拼接上一步结果。

为了验证以上推断，先将本地存储值清除，断点并在控制台输出查看相关函数。首先是`u.c`：

```javascript
function r(e) {
    try {
        if ("undefined" == typeof navigator)
            return "unknown";
        var t = navigator.platform
            , n = navigator.userAgent
            , r = ""
            , a = "";
        return t.indexOf("Win") > -1 ? n.indexOf("Windows NT 5.0") > -1 ? r += "Win2000" : n.indexOf("Windows NT 5.1") > -1 ? r += "WinXP" : n.indexOf("Windows NT 5.2") > -1 ? r += "Win2003" : n.indexOf("Windows NT 6.0") > -1 ? r += "WindowsVista" : n.indexOf("Windows NT 6.1") > -1 ? r += "Win7" : n.indexOf("Windows NT 6.2") > -1 ? r += "Win8" : n.indexOf("Windows NT 6.3") > -1 ? r += "Win8.1" : n.indexOf("Windows NT 6.4") > -1 || n.indexOf("Windows NT 10.0") > -1 ? r += "Win10" : r += "Other" : t.indexOf("Mac") > -1 ? r += "Mac" : t.indexOf("X11") > -1 ? r += "Unix" : t.indexOf("Linux") > -1 ? r += "Linux" : r += "Other",
        r += e,
        /[Ff]irefox(\/\d+\.\d+)/.test(n) ? (a = /([Ff]irefox)\/(\d+\.\d+)/.exec(n),
        r += a[1] + a[2]) : /MSIE \d+\.\d+/.test(n) ? (a = /MS(IE) (\d+\.\d+)/.exec(n),
        r += a[1] + a[2]) : /[Cc]hrome\/\d+/.test(n) ? (a = /([Cc]hrome)\/(\d+)/.exec(n),
        r += a[1] + a[2]) : /[Vv]ersion\/\d+\.\d+\.\d+(\.\d)* *[Ss]afari/.test(n) ? (a = /[Vv]ersion\/(\d+\.\d+\.\d+)(\.\d)* *([Ss]afari)/.exec(n),
        r += a[3] + a[1]) : /[Oo]pera.+[Vv]ersion\/\d+\.\d+/.test(n) ? (a = /([Oo]pera).+[Vv]ersion\/(\d+)\.\d+/.exec(n),
        r += a[1] + a[2]) : r += "unknown",
        r.indexOf("IE") > -1 ? "windows_IE" : r
    } catch (e) {
        return l.a.warn("获取系统名和浏览器名失败", e),
        "unknown"
    }
}
```

主要根据`navigator.platform`和`navigator.userAgent`获取操作系统和浏览器信息，中间过程整挺复杂，不过对我们来说就固定它是`Win7/Chrome100`就行了。再看`c.a`：

```javascript
function r() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(e) {
        var t = 16 * Math.random() | 0;
        return ("x" === e ? t : 3 & t | 8).toString(16)
    })
}
```

自定义的uuid生成规则，中间有个4是固定不变的，`x`的值是`t`，0-15之间的随机整数（或运算|快速取整），`y`取值多了一点运算。这个函数需要原样抠出来。

再看第二个拼接过程的函数`u.b`：

```javascript
function o(e) {
    return u.a.encoder(s()(e, c.h)).charAt(2)
}
```

此处再断点。在控制台打印`c.h`为固定字符串`£¬¡£fdjf,jkgfkl`，`s()`如下：

```javascript
e.exports = function(e, t) {
    return d(e + (t || ""))
}
```

即拼接两个字符串，再由`d`处理返回。`d`正好在这个函数上面定义，把这部分完整抠下来：

```javascript
, function(e, t, n) {
    "use strict";
    function r(e) {
        for (var t = "", n = 0; n <= 3; n++)
            t += p.charAt(e >> 8 * n + 4 & 15) + p.charAt(e >> 8 * n & 15);
        return t
    }
    function o(e) {
        var t, n = 1 + (e.length + 8 >> 6), r = new Array(16 * n);
        for (t = 0; t < 16 * n; t++)
            r[t] = 0;
        for (t = 0; t < e.length; t++)
            r[t >> 2] |= e.charCodeAt(t) << t % 4 * 8;
        return r[t >> 2] |= 128 << t % 4 * 8,
        r[16 * n - 2] = 8 * e.length,
        r
    }
    function i(e, t) {
        var n = (65535 & e) + (65535 & t);
        return (e >> 16) + (t >> 16) + (n >> 16) << 16 | 65535 & n
    }
    function a(e, t) {
        return e << t | e >>> 32 - t
    }
    function s(e, t, n, r, o, s) {
        return i(a(i(i(t, e), i(r, s)), o), n)
    }
    function l(e, t, n, r, o, i, a) {
        return s(t & n | ~t & r, e, t, o, i, a)
    }
    function u(e, t, n, r, o, i, a) {
        return s(t & r | n & ~r, e, t, o, i, a)
    }
    function c(e, t, n, r, o, i, a) {
        return s(t ^ n ^ r, e, t, o, i, a)
    }
    function f(e, t, n, r, o, i, a) {
        return s(n ^ (t | ~r), e, t, o, i, a)
    }
    function d(e) {
        for (var t = o(e), n = 1732584193, a = -271733879, s = -1732584194, d = 271733878, p = 0; p < t.length; p += 16) {
            var h = n
              , v = a
              , m = s
              , y = d;
            n = l(n, a, s, d, t[p + 0], 7, -680876936),
            d = l(d, n, a, s, t[p + 1], 12, -389564586),
            s = l(s, d, n, a, t[p + 2], 17, 606105819),
            a = l(a, s, d, n, t[p + 3], 22, -1044525330),
            n = l(n, a, s, d, t[p + 4], 7, -176418897),
            d = l(d, n, a, s, t[p + 5], 12, 1200080426),
            s = l(s, d, n, a, t[p + 6], 17, -1473231341),
            a = l(a, s, d, n, t[p + 7], 22, -45705983),
            n = l(n, a, s, d, t[p + 8], 7, 1770035416),
            d = l(d, n, a, s, t[p + 9], 12, -1958414417),
            s = l(s, d, n, a, t[p + 10], 17, -42063),
            a = l(a, s, d, n, t[p + 11], 22, -1990404162),
            n = l(n, a, s, d, t[p + 12], 7, 1804603682),
            d = l(d, n, a, s, t[p + 13], 12, -40341101),
            s = l(s, d, n, a, t[p + 14], 17, -1502002290),
            a = l(a, s, d, n, t[p + 15], 22, 1236535329),
            n = u(n, a, s, d, t[p + 1], 5, -165796510),
            d = u(d, n, a, s, t[p + 6], 9, -1069501632),
            s = u(s, d, n, a, t[p + 11], 14, 643717713),
            a = u(a, s, d, n, t[p + 0], 20, -373897302),
            n = u(n, a, s, d, t[p + 5], 5, -701558691),
            d = u(d, n, a, s, t[p + 10], 9, 38016083),
            s = u(s, d, n, a, t[p + 15], 14, -660478335),
            a = u(a, s, d, n, t[p + 4], 20, -405537848),
            n = u(n, a, s, d, t[p + 9], 5, 568446438),
            d = u(d, n, a, s, t[p + 14], 9, -1019803690),
            s = u(s, d, n, a, t[p + 3], 14, -187363961),
            a = u(a, s, d, n, t[p + 8], 20, 1163531501),
            n = u(n, a, s, d, t[p + 13], 5, -1444681467),
            d = u(d, n, a, s, t[p + 2], 9, -51403784),
            s = u(s, d, n, a, t[p + 7], 14, 1735328473),
            a = u(a, s, d, n, t[p + 12], 20, -1926607734),
            n = c(n, a, s, d, t[p + 5], 4, -378558),
            d = c(d, n, a, s, t[p + 8], 11, -2022574463),
            s = c(s, d, n, a, t[p + 11], 16, 1839030562),
            a = c(a, s, d, n, t[p + 14], 23, -35309556),
            n = c(n, a, s, d, t[p + 1], 4, -1530992060),
            d = c(d, n, a, s, t[p + 4], 11, 1272893353),
            s = c(s, d, n, a, t[p + 7], 16, -155497632),
            a = c(a, s, d, n, t[p + 10], 23, -1094730640),
            n = c(n, a, s, d, t[p + 13], 4, 681279174),
            d = c(d, n, a, s, t[p + 0], 11, -358537222),
            s = c(s, d, n, a, t[p + 3], 16, -722521979),
            a = c(a, s, d, n, t[p + 6], 23, 76029189),
            n = c(n, a, s, d, t[p + 9], 4, -640364487),
            d = c(d, n, a, s, t[p + 12], 11, -421815835),
            s = c(s, d, n, a, t[p + 15], 16, 530742520),
            a = c(a, s, d, n, t[p + 2], 23, -995338651),
            n = f(n, a, s, d, t[p + 0], 6, -198630844),
            d = f(d, n, a, s, t[p + 7], 10, 1126891415),
            s = f(s, d, n, a, t[p + 14], 15, -1416354905),
            a = f(a, s, d, n, t[p + 5], 21, -57434055),
            n = f(n, a, s, d, t[p + 12], 6, 1700485571),
            d = f(d, n, a, s, t[p + 3], 10, -1894986606),
            s = f(s, d, n, a, t[p + 10], 15, -1051523),
            a = f(a, s, d, n, t[p + 1], 21, -2054922799),
            n = f(n, a, s, d, t[p + 8], 6, 1873313359),
            d = f(d, n, a, s, t[p + 15], 10, -30611744),
            s = f(s, d, n, a, t[p + 6], 15, -1560198380),
            a = f(a, s, d, n, t[p + 13], 21, 1309151649),
            n = f(n, a, s, d, t[p + 4], 6, -145523070),
            d = f(d, n, a, s, t[p + 11], 10, -1120210379),
            s = f(s, d, n, a, t[p + 2], 15, 718787259),
            a = f(a, s, d, n, t[p + 9], 21, -343485551),
            n = i(n, h),
            a = i(a, v),
            s = i(s, m),
            d = i(d, y)
        }
        return r(n) + r(a) + r(s) + r(d)
    }
    var p = "0123456789abcdef";
    e.exports = function(e, t) {
        return d(e + (t || ""))
    }
}
```

为了确保能用，找块地粘贴运行，需要把最后的`e.exports = `替换成`return`，最后加上函数名`s`。没有问题。

继续上面`u.a.encoder(s()(e, c.h)).charAt(2)`的过程，还差最外面的`u.a.encoder`。找到定义部分，完成抠下来：

```javascript
, function(e, t, n) {
    "use strict";
    var r = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "+", "/"]
      , a = function(e) {
        for (var t = new Array; e > 0; ) {
            var n = e % 2;
            e = Math.floor(e / 2),
            t.push(n)
        }
        return t.reverse(),
        t
    }
      , o = function(e) {
        for (var t = 0, n = 0, r = e.length - 1; r >= 0; --r) {
            1 == e[r] && (t += Math.pow(2, n)),
            ++n
        }
        return t
    }
      , i = function(e, t) {
        for (var n = 8 - (e + 1) + 6 * (e - 1), r = t.length, a = n - r; --a >= 0; )
            t.unshift(0);
        for (var o = [], i = e; --i >= 0; )
            o.push(1);
        o.push(0);
        for (var s = 0, u = 8 - (e + 1); s < u; ++s)
            o.push(t[s]);
        for (var l = 0; l < e - 1; ++l) {
            o.push(1),
            o.push(0);
            for (var c = 6; --c >= 0; )
                o.push(t[s++])
        }
        return o
    }
      , s = {
        encoder: function(e) {
            for (var t = [], n = [], s = 0, u = e.length; s < u; ++s) {
                var l = e.charCodeAt(s)
                  , c = a(l);
                if (l < 128) {
                    for (var d = 8 - c.length; --d >= 0; )
                        c.unshift(0);
                    n = n.concat(c)
                } else
                    l >= 128 && l <= 2047 ? n = n.concat(i(2, c)) : l >= 2048 && l <= 65535 ? n = n.concat(i(3, c)) : l >= 65536 && l <= 2097151 ? n = n.concat(i(4, c)) : l >= 2097152 && l <= 67108863 ? n = n.concat(i(5, c)) : l >= 4e6 && l <= 2147483647 && (n = n.concat(i(6, c)))
            }
            for (var f = 0, s = 0, u = n.length; s < u; s += 6) {
                var p = s + 6 - u;
                2 == p ? f = 2 : 4 == p && (f = 4);
                for (var h = f; --h >= 0; )
                    n.push(0);
                t.push(o(n.slice(s, s + 6)))
            }
            for (var m = "", s = 0, u = t.length; s < u; ++s)
                m += r[t[s]];
            for (var s = 0, u = f / 2; s < u; ++s)
                m += "=";
            return m
        },
        decoder: function(e) {
            var t = e.length
              , n = 0;
            "=" == e.charAt(t - 1) && ("=" == e.charAt(t - 2) ? (n = 4,
            e = e.substring(0, t - 2)) : (n = 2,
            e = e.substring(0, t - 1)));
            for (var i = [], s = 0, u = e.length; s < u; ++s)
                for (var l = e.charAt(s), c = 0, d = r.length; c < d; ++c)
                    if (l == r[c]) {
                        var f = a(c)
                          , p = f.length;
                        if (6 - p > 0)
                            for (var h = 6 - p; h > 0; --h)
                                f.unshift(0);
                        i = i.concat(f);
                        break
                    }
            n > 0 && (i = i.slice(0, i.length - n));
            for (var m = [], v = [], s = 0, u = i.length; s < u; )
                if (0 == i[s])
                    m = m.concat(o(i.slice(s, s + 8))),
                    s += 8;
                else {
                    for (var g = 0; s < u && 1 == i[s]; )
                        ++g,
                        ++s;
                    for (v = v.concat(i.slice(s + 1, s + 8 - g)),
                    s += 8 - g; g > 1; )
                        v = v.concat(i.slice(s + 2, s + 8)),
                        s += 8,
                        --g;
                    m = m.concat(o(v)),
                    v = []
                }
            return m
        }
    };
    t.a = s
}
```

同样的具体逻辑不管，我们只需要调用函数内的`encoder`即可。稍加改造：加上函数名，我们还需要在外面传入对象`t`，最终调用`t.a.encoder`：

```javascript
let u = {};
let e = '';
function foo(e, t, n){
    ...
};
foo(e, u, '');
n.a.encoder('xxx');  // 调用
```

最后结果取`charAt(2)`单个字符，再拼接`wWin7/Chrome100/xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`，就是最终的device_id了。

## login_name&password

全局搜索关键字，定位到明文到密文的加密代码段：

```javascript
t._login = function() {
	var e = this
	  , t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : {}
	  , n = t.loginName  // 用户名明文
	  , r = t.password   // 密码明文
	  , a = t.identifyCode
	  , o = t.loginNameType
	  , i = t.accountType
	  , s = t.countryCode
	  , u = t.orgCode
	  , l = t.isGetTicketForLogin
	  , c = arguments.length > 1 ? arguments[1] : void 0;
	return this.getSession().then(function(t) {
		var d = t.session_id
		  , f = t.session_key
		  , p = Object(B.d)(n, f)   // 用户名加密过程
		  , h = Object(B.d)(N()(r, G.h), f)  // 密码加密过程
		  , m = {
			session_id: d,
			login_name_type: o,
			login_name: p,  // 最终提交用户名
			account_type: i,
			country_code: s,
			org_code: u,
			password: h,  // 最终提交密码
			identify_code: a
		};
		return l ? e._ucGateway.getLoginTicketByPassword(m) : e._ucGateway.loginByPassword(m).then(function(e) {
			return Object(B.b)(e, f)
		}).then(function(t) {
			return e._ucToken.saveToken(t, c)
		})
	})
}
```

`n, r`对应用户名密码明文，`p, h`对应密文。加密过程分别为：

```javascript
, p = Object(B.d)(n, f)   // 用户名加密过程
, h = Object(B.d)(N()(r, G.h), f)  // 密码加密过程
```

先看用户名。`f`是`session_key`由sessions请求得到，断点找到`B.d`定义处：

```javascript
function r(e, t) {
    return e += "",
    s.a.DES.encrypt(e, s.a.enc.Utf8.parse(t), {
        mode: s.a.mode.ECB,
        padding: s.a.pad.Pkcs7
    }).toString()
}
```

DES对称加密算法，ECB移位模式，`Pkcs7`填充方式。因为是经典加密算法，扣代码太长了，直接调用Python或Node.js的加密库[cryptojs](https://cryptojs.gitbook.io/)。第一参数是明文，第二参数秘钥使用session_key。

密码加密多了一步`N()`，查看`G.h`，是字符串`£¬¡£fdjf,jkgfkl`，和前面分析过的`s()(e, c.h)`一样，`N()`即`s()`，`G.h`即`c.h`。

## 总结

node.js实现请参考：[https://stackblitz.com/edit/node-zxxedu](https://stackblitz.com/edit/node-zxxedu)


